## 第2章：网络分层的真实含义是什么

<b> 1.网络分层的意义和我们传统软件开发的MVC目的是一样的，分层即为了解耦。</b>  
<b> 2.只要是跑在网络上的包，都是完整的。可以有下层没上层，但绝对不可能有上层没下层。</b>  
<b> 3.一包网络包从A到到B，简单说就是经历自上而下的层层装包，然后又经历了自下至上的层层拆包</b>  
<b> 4.有了IP地址为什么还要有MAC地址？</b>  
>（1）IP地址是OSI三层的地址；MAC地址是OSI二层地址。  
>（2）基于第1点，在广域网中寻址使用IP地址；在局域网中寻址使用MAC地址。  
>（3）IP地址具有定位功能；而MAC地址具有标识功能。


## 第3章：ifconfig：最熟悉又陌生的命令行

<b> 1.在Linux中，除了ifconfig以外，还可以使用另一个命令“ip addr”来查看我们的网卡信息。</b>  
<b> 2.关于IP地址</b>  
>（1）我们目前使用的IPv4地址占32位，也就是4字节；目前没有推广开的IPv6地址占128位，16字节。  
>（2）一个IP地址的组成包含“类型”、“网络号”和“主机号”三部分。  
>（3）网络号：我们的IPv4地址被划分为5大类，分别用“0”、“10”、“110”、“1110”和“11110”来区分标识。  
>    <img src="chapter3-1.jpg" />
>（4）根据IP所属的类型不同，所能表达的"网络号"和“主机号”数量也是有所不同。  
>   <img src="chapter3-2.jpg" />
> &nbsp;&nbsp;&nbsp;&nbsp;补充说明：上图中只是列举了ABC三类地址，未列出的D类（224.0.0.1-239.255.255.254）地址是广播地址；而E类是保留地址。  
>（5）IPv4地址面临的问题：C类地址包含的主机数太少；而A类B类地址包含的主机数又太多，造成地址浪费。  
>（6）基于第5点提出的问题，后续有了无类型域间选路（CIDR）解决方案：通过配置子网掩码将IP地址一分为二，通过将子网掩码和IP进行“&”运算，就可以求出IP的网络号。  
>（7）基于CIDR，为了区分出广域网和局域网，又将每一类IP地址分出了私有和公有范围：
>   <img src="chapter3-3.jpg" />   
> 补充说明：CIDR不是为了区分私有网络和公有网络，而是用来判断来访IP和当前LAN是否同一网段。  
>（8）网络层到链路层之间为什么要进行分包处理：IP层之所以分包，是因为链路层MTU限制导致，而在网络传输过程中，各个链路层的MTU值也会发生变化。 

<b> 3.关于MAC地址</b>
> （1）MAC作为物理网卡地址，采用16进制标识，占用6字节。  
> （2）MAC地址理论上全球唯一，但实际上只能做到也必须是局域网唯一。  
<b> 4.关于网卡处理网络包的策略</b>  
> （1）默认采用fifo策略，先进先出。
> （2）fifo_fast更加复杂一些，采用3个band：band0优先级最好，band2优先级最低。如果band0有数据包，则优先处理，band1和band2稍后。
> （3）网络传过来的数据包，会进入哪个band，由IP头中的TOS字段（服务类型）记录。


## 第4章：DHCP与PXE

#### 1.IP默认的寻址逻辑
> （1）首先判断目标IP和本机IP是否同一网段  
> （2）同一个网段时，发送ARP请求，将MAC地址补充完整，然后将网络包交给交换机转发到目的地。  
> （3）如不在同一网段，则是将网络包发送至网关，由网关决定网络包的路由路径。  

#### 2.关于DHCP协议 
> 一种自动为终端分配IP的协议，即动态配置主机协议（Dynamic Host Configuration Protocal）

#### 3.DHCP工作方式
> （1）新机器加入网络时，由于没有被分配IP，只有自身MAC地址，因此会进行“DHCP Discover”，使用UDP协议，IP地址为“0.0.0.0”来发一条“Boot Request”广播（广播地址为255.255.255.255），试图获取在LAN内IP。  
> （2）当DHCP Server收到广播后，会随即对其进行回复：也是使用UDP协议，发送一条广播，将分配好的IP告知新机器，这个步骤称之为“DHCP Offer”。  
> &nbsp;&nbsp;补充说明：虽然DHCP Server得知了新机器的MAC地址，但仍采用广播方式，我猜是因为使用UDP协议时一定要基于IP，无法直接使用MAC地址。  
> （3）新机器收到DHCP Server的答复后，会在发送一条广播，告知自己准备使用Server分配的IP地址。意图也在告知其他消息后置的Server撤销IP分配，以便提供给下一个IP租用者。  
> &nbsp;&nbsp;补充说明：此时，由于新机器还没有得到DHCP Server的最终回复，IP地址仍采用”0.0.0.0“。  
> （4）最终DHCP收到新机器的确认后，广播发送“DHCP ACK”回执，并将这组IP和MAC加入到路由配置表中，后续通讯即可通过IP发送。
  
#### 4.关于PXE批量安装操作系统：文章只提供思路，日后需要时再实践即可。

## 第5章：从物理层到链路层
#### 1.物理层
>（1）位居OSI模型中第一层，其作用是为网络设备之间提供联通、互联、传输。该层关心的是信号与介质，例如双绞线，同轴电缆、光纤等。二进制数据只有通过网卡先转换成正负极、强弱电、光波的闪灭来表示并传输。  
>（2）物理层设备：网线、中继器（放大信号，延长传输距离）和集线器（可以连接多台设备）  

#### 2.链路层
>（1）链路层也叫MAC层，即媒体访问控制，通过名称可大致了解OSI定义这层的目的，该层关心的是数据发送逻辑，包括检测报文完整性（CRC，通过XOR异或算法，来计算整个包是否在发送过程中出现问题）。  
>（2）链路层设备：网桥（早期2层设备，相当于一个2口的交换机），交换机。  
>（3）链路层协议：IEEE、FDDI、ATM，PPTP、MPLS、ARP协议（前3个属于1层2层协议，PPTP和MPLS都是实现VPN技术不同的协议，PPTP只在2层工作，而MPLS则在和ARP一样，属于2层3层协议）  
> &nbsp;&nbsp;待考证：在实际网络架构中，链路层采用的协议不同，也需要物理层传输介质改变，因此例如我们常见的IEEE、FDDI、ATM等协议都是跨物理层和链路层，而我们最常见的网卡设备，也是同时工作在一层和二层的设备。

#### 3.集线器(Hub)与交换机(Switch)对比
>（1）Hub属于1层设备；Switch属于2层设备。  
>（2）Hub采用广播方式传输数据；Switch通过自我学习方式，构建转发表。  
>（3）Switch支持生成树算法，可以构建出物理有环路，而逻辑无环的网络。  

## 第6章：交换机与VLAN
#### 1.如何解决网络中的环路问题
>（1）使用最小生成树的方式，解决网络拓扑图中的环路问题。  

#### 2.关于网络拓扑图中最小生成树的问题（STP）
>（1）回顾STP算法思想：STP算法的目的是用最小代价求出最短联通路径，当联通路径求出时，也顺带解决了环路问题。  
>（2）根据IEEEE802.1D定义，每个网桥必须在每1-10秒内交换BPDU包，从而判断端口使用情况，来消除环路。  
>（3）生成树的算法和网桥设备没有任何关系，只要设备能提供生成树的算法，就可以消除环路问题。  

#### 3.如何解决广播和安全问题
> 一种解决方案就是划分出子网，将多个网络进行隔离，其中可以进行物理隔离和虚拟隔离。  
> &nbsp;（1）物理隔离：虽然实现隔离，但扩展性、灵活性较差，每次改动需要依赖硬件支持。  
> &nbsp;（2）虚拟隔离(VLAN)：虚拟局域网，工作在第二层的协议，其原理是在Mac包头上加一个Tag，附上VLAN ID，这个ID占用12位，可表示4096个网络。当交换机再转发数据包时，会先取下Mac头上的VLAN ID，判断只有相同的VLAN ID才会进行转发给自己域内的主机。而交换机之间通过Trunk口相连，这种口可以转发属于任何VLAN的数据包。  

## 第7章：ICMP与Ping命令
#### 1.关于ICMP协议
> （1）ICMP全称是Internet Control Message Protocol，即互联网控制报文协议。属于OSI模型上的第三层协议，使用UDP协议传输数据包。  
> （2）查询报文：例如基于ICMP协议封装的ping命令，以及ping命令里使用的TTL字段，也均所属ICMP协议。  
> （3）差错报文分类  
>> ① 主机不可达：回应客户端目标主机不可达的原因（例如主机不可达、端口不可达、协议不可达等等）；  
>> ② 源站抑制：通俗而言网络拥堵，生产大于消费，目标主机待处理请求过多，希望发送方减缓速度。  
>> ③ 时间超时：TTL消耗完毕，但仍未到达主机。  
>> ④ 路由重定向：发现到达目标主机比当前更短的路径。  

#### 2.Ping命令工作详解
> （1）构建Ping该命令：  
>> ① 封装ICMP数据包：例如本例中是请求数据包，因此ICMP的类型字段设置为8。  
>> ② 顺序号：每发一个ping命令，都会将顺序号加1。（我们一般使用ping命令时，都会发送一批数据包，来判定网络情况，例如：不带参数的ping则会发送3次报文；而ping -t则会无休止的发送数据包）  
>> ③ 时间戳：为了计算RTT（往返时间）会在报文数据部分插入时间戳。  

>（2）发送命令：将上面封装好的报文和IP地址，一并由ICMP协议提交给IP层发送。  
>（3）到达目标主机：数据包如何经过局域网、广域网等网络与Ping无关，省略...  
>（4）主机响应：主机构建ICMP应答包，使用同等于请求包的顺序号，原路发送回去。  
>&nbsp;&nbsp;补充说明：如果在规定时间内，源主机没有收到ICMP应答，则说明主机不可达。  


#### 3.使用tcpdump抓包查看ping命令
>（1）在“服务器终端”上使用“tcpdump -i eth0 icmp”命令（参数”-i eth0“代表监听eth0网卡的数据包，参数”icmp“代表只关注icmp协议。）  
>（2）在本机ping服务器IP，观察“服务器终端”输出如下：
>>19:31:44.983620 IP 223.72.61.125 > iZj6c1nz3zaf1odb59wcd5Z: ICMP echo request, id 22019, seq 0, length 64
19:31:44.983658 IP iZj6c1nz3zaf1odb59wcd5Z > 223.72.61.125: ICMP echo reply, id 22019, seq 0, length 64

#### 4.Traceroute查询差错报文
>（1）Traceroute命令目的是利用ICMP协议来追踪出”源主机“到”目标主机“所经过的路由器。  
>（2）Traceroute原理：基于ICMP协议，通过递增设置TTL来进行追踪出路由器IP（首次TTL为1）；通过设置上层协议UDP错误端口（30000以上的端口），来判断主机是否可达。   

## 第8章：路由器工作原理简析
#### 1.关于MAC头和IP头
>（1）目标机器与源主机在同一个网段：直接将源地址和目标地址填入IP头，然后通过ARP获得目标主机的MAC地址，将源MAC地址和目标MAC地址填入到MAC头，最后发出去即可。  
>（2）目标机器与源主机不在同一网段：  
>> ① 通过CIDR得知目标主机与源主机不在同一网段，因此先将源主机IP和网关IP地址填入到IP头。  
>> ② 知道网关IP地址后，通过ARP获得网关MAC地址，然后连同自己的MAC地址一并填入到MAC头发送到网关。  

>![](chapter8-1.jpg)  

#### 2.网关工作原理（待整理）</b>  
> 为了方便理解，网关以我们常见的家用5口路由器为例（1个WAN口，4个LAN口）。  
>（1）在家里使用时，WAN口使用的IP地址一般多为ISP提供的静态或动态公网IP地址；而LAN口所使用的IP则是局域网中分配的内网IP地址。  
>（2）数据包从LAN口进入到出WAN口，就是一个NAT的过程。  
>（3）路由器内部的路由表，分为静态路由和动态路由。  
>（4）NAT技术的出发点就是为了解决IPv4地址不足的问题。VLSM和CIDR就是通过调整子网掩码长度来实现这个目的。从而将内网IP+端口的方式转化成外网地址，以降低对公网IP的需求。  
>（5）不改变IP地址的网关，我们称为转发网关；改变IP地址的我们成为NAT网关。
>（6）NAT的工作原理：当网关收到LAN主机的请求时，发现要出网关，因此要做NAT映射；网关的处理结果是将数据包的源IP头取下，换成WAN口的IP地址，目标地址不变，发送到外网；当数据包回来后，网关再根据端口号使用NAT转换成内网IP。  

## 第9章：路由配置
#### 1.静态路由
> 通过ip rule add命令添加路由规则。  

#### 2.动态路由
>（1）距离矢量路由：是一种以距离（代价）和方向决定目标网络或主机位置的一种路由算法。   
>（2）链路状态算法：是网络内每个路由器在了解整个网络状态之上，且信息同步的前提下，动态生成路由表的一种方法。  

#### 3.RIP协议
>（1）工作原理：RIP将路由控制表信息定期（每30秒）向全网广播；如果超过6次（180秒）没有收到某一个网络邻居发来的报文，则将该网路邻居标记为不可达状态；超过10次（300秒）仍未有消息，则将该网络邻居从路由表删除。   
>（2）基于UDP协议，广泛应用于小型局域网，默认使用端口520。  
>（3）关于毒性逆转和触发更新：在得知邻居不可达时，不等30秒，立即发送一个16跳的通知，达到迅速收敛。  
>（4）RIP协议的缺点：
>> ① 最大只有15条，因此无法应用在大型网络中（为了限制收敛时间，超过15跳则认为网络不可达）   
>> ② 以”跳“数作为网络距离尺度，因此在不同介质为传输导体的网络中，求得的最短路径有可能不准确（例如：A-B-C的连通介质采用百兆光纤，同时A和C也又用56K调制解调器连通，此时从A到C的最短路径时直连，但传输效率最高的路线是A-B-C）  
>> ③ 周期性发送自己的路由信息，浪费流量，收敛速度缓慢。  
>> ④ 本身算法存在环路可能性较大。

#### 4.OSPF协议
>（1）OSPF属于内部网关协议，用于单一自治系统，属于”链路状态路由协议“  
>（2）相比RIP协议，OSPF引入了权重可以更加准确对路由进行选择。  
>（3）RIP有一个非常严重的缺点，当网络的个数越多，每次要交换的控制信息就越大；且当网络已经处于比较稳定，没有什么变化状态时，还是要定期交换路由控制信息，造成带宽浪费。
>（4）OSPF数据库表：
>> ① 网络链路状态表：记录了连接邻居关系的路由器。  
>> ② 路由器链路状态表：记录当前路由器所在区域的所有链路状态信息（拓扑图），并实时同步，保证处在同一区域的路由器的”路由器链路状态表“的数据一致。  
>> ③ 路由器控制表：从当前路由器节点为根，求得到达每个路由器节点的最短路径。  

>（5）将区域分层，细化管理：当网络规模越来越大时，链路拓扑图也随之增长，路由信息越来越难以计算，且一个点的变更引发的关联变更波及范围也越来越广，因此OSPF为了降低负荷，引入了区域的概念。  
>（6）AS内的子区域必须与”主干区域“相连，主干区域由”边界路由器“和”主干路由器“构成。  

#### 5.BGP协议
>（1）边界网关协议，用于连接不同自治域（AS）的网络协议，主要用于连接不同的ISP形成规模更大的网络。  
>（2）每个自治域都有边界路由器，通过它和外面的世界相连，使用的协议就是BGP协议。  
>（3）每个AS内可以有可有多个子区域，但每个子区域必须有一个边界路由器相连。  
>（4）BGP分为IBGP和EBGP：
>> IBGP：内部BGP协议，在AS内部进行BGP路由信息交换。  
>> EBGP：外部BGP协议，AS之间进行路由信息交换；目前各个AS之间连接协议，有且只有EBGP一种。  

>（5）BGP与RIP一样，也使用”路径向量路由协议“。

## 第10章：UDP协议
#### 1.UDP协议特性
>（1）全称是”User Datagram Protocol“，在OSI模型里是无连接的传输层协议，提供简单传输，面向事务不可靠的传输协议（<font color='blue'>这里的面向事务该怎么理解？</font>）。  
>（2）相比TCP协议，UDP在传输效率上更快，但可靠性不足。  
>（4）QUIC：Quick UDP Internet Connections，是Google开发的一套，基于UDP实现的可靠性传输应用层协议。
>（5）UDP协议头
>![](chapter10-1.jpg)

#### 2.UDP使用场景
>（1）需要资源少，网络情况比较好的内网，或对于丢包不敏感的应用，例如DHCP、PXE。  
>（2）不需要一对一，而是采用广播的方式建立应用。由于UDP不需要维护连接状态，因此可以承载多播或广播协议。例如直播平台，丢的包再次重发过来也没有用了，因为视频已经播放到下一帧了，相比清晰度用户更关注的是播放流畅。  
>（3）需要低延时，处理速度快的应用，但前提是可以忍受少数丢包，例如一些要求实时性较高的大型网游。

## 第11章：TCP协议
#### 1.TCP基本概念
>（1）全双工协议：TCP之间的数据是可以两个方向流动，通俗而言就是一个端口可读也可写。  
>（2）可靠性传输协议：  
>（3）面向连接：TCP的两个应用程序在交换数据之前，必须通过相互联系建立一个TCP连接。  
>（4）无插入标识与消息边界：TCP报文在传输过程中可以任意拆分或重组，例如发送端分3次写入了80字节：10bytes、20bytes和50bytes；而接收端可能会以4次读取，每次读取20bytes接收传过来的80bytes。  
>（5）关于传输单位表示：TCP层传输用段（segment）表示；网络层用包（pack）表示；链路层用帧（frame）表示。    
>（6）TCP协议头格式  
>![](chapter11-1.jpg)

#### 2.TCP工作原理
>（1）建立连接：通过3次握手建立连接。  
>> ① 第一次握手  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;客户端发送一个SYN报文段（TCP头部开启SYN标识），并指明目标端口号，以及生成初始序列号ISN（<font color='blue'>ISN细节待补充</font>）。而且通常情况下，客户端还会借此多发一个TCP头部选项（<font color='blue'>细节待补充</font>）。  
>> ② 第二次握手  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务端也会发送自己的ISN作为SYN报文段，并将收到客户端的SYN+1，作为自己收到数据的凭证，即ACK部分。因此双方没法送一个SYN，其SN就加1，通过以此方式来配合计数器实现重传机制（开启SYN+ACK标识）。  
>> ③ 第三次握手  
>> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;客户端收到服务器的ACK后，会告知服务器连接成功，将服务端SYN值加1作为自己的ACK，发给服务端（只开启ACK标识）

>（2）传输数据：发送方发送一个分组，然后等待接收方的ACK；接收方收到这个分组后，给发送方回应一个ACK；当发送方接到ACK时，再发送下一个分组。  
>（3）断开连接：4次挥手关闭连接。  
>（4）关于发送ACK的时机：首先要知道的是，TCP在接到对端的数据后不会立即发送ACK的。TCP使用的ACK是积累的，某种意义上而言，ACK暗示了被成功收到的bytes数，因此，假如只是中间一个ACK丢失，后面的ACK是足可以证明前面的报文段都已被成功接收了。  
>（5）滑动窗口与重传计时器：TCP采用滑动窗口机制来发送报文，因此不会为每一个报文段设置一个重传计时器，而是发送一个窗口的数据，只设置一个计时器。


## 第12章：TCP协议常见问题

#### 1.为什么采用3次握手，而不是2次或4次？  
> 2次握手可靠性无法得到保障，4次握手又会造成浪费。因此在第4次握手时，可以刚好保障连接建立。另一个原因也是取决于TCP协议的实现，TCP为了保证数据的顺序性，必须使用SYN和ACK，而第三次握手时，也确保了Server能收到Client的ACK编号。  
> ![](chapter11-2.jpg)  

#### 2.挥手4次的原因
> 4次挥手其实就是两次FIN-ACK，只不过TCP是全双工的原因，每个方向都需要单独进行关闭，因此看上去就成了4次传输。
> ![](chapter11-3.png)

#### 3.如果ACK丢失怎么办？
> 当ACK在传输丢失时，作为发送方只需要重发分组即可；而接收方因为发送方重发机制的原因，可能会收到重复的分组，为了避免重复分组带来的负效应，所以接收方需要使用序列号（sequence number）来做幂等校验，对于重复的分组直接舍弃，不做任何处理。

#### 4.发送方Send后，等待ACK多长时间算超时？

#### 5.分组接到后，如何判断里面有错？
> TCP通过编码方式（CRC和检验和？具体是用哪一种呢）来检测分组中的差错。当接收方收到错误分组时，不发送ACK，等待发送方重新发送分组。

#### 6.接收方如何处理乱序的分组？

#### 7.发送方的重传机制依赖定时器，那么发送方在等待ACK时是怎样维持定时器呢？
> * 理论上发送方在等待ACK的时间计算方式：发送分组时间+接收方处理时间+接收方回ACK时间+ACK返回到发送方时间+发送方处理ACK时间。  
* 但由于这期间的任一时间都存在不确定性，因此ACK的超时时间也难以量化，所以相对更好的策略是让协议根据当前传输情况去做预估。简言之，方向就是选择一组RTT（往返时间）样本来取平均值。由于这个平均值也会随着当前网络状况而发生改变，因此更能真实的预估出超时时间。
	
#### 8.接收方的接收速率比发送方的发送速率要慢怎么办？
> 通过滑动窗口机制来协调发送方和接收方的传输速率。在这种流控机制（flow control）里，窗口的大小不是固定的，是随时允许变化的。发送方以及接收方在每次通信报文文都会包含"窗口大小"，以此方式来达到流量控制的目的。

#### 9.如何解决网络拥塞的问题：例如中间的网络基础设施（例如路由器）处理不了发送方或接收方指定的速率怎么办？
> （参考第16章）

待整理：
>（2）如何保证数据包不会乱序  
>（3）如何避免丢包  
>（4）如何拥塞控制  
>（5）流量控制  
>